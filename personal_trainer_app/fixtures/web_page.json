[
 {
  "breadcrumbs": null,
  "content_type": "HTML",
  "context_script": null,
  "css": "html,\nbody {\n    height: 100% !important;\n}\n.navbar{\n    display: none;\n}\n.web-footer{\n    display: none;\n}",
  "docstatus": 0,
  "doctype": "Web Page",
  "dynamic_route": 0,
  "dynamic_template": 0,
  "enable_comments": 0,
  "end_date": null,
  "full_width": 1,
  "header": null,
  "insert_style": 1,
  "javascript": "",
  "main_section": null,
  "main_section_html": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no\">\n    <title>Chat App</title>\n   <style>\n        :root {\n            --bg-primary: #000000;\n            --bg-secondary: #1a1a1a;\n            --indigo: #818cf8;\n            --purple: #a855f7;\n            --violet: #8b5cf6;\n            --text-primary: #ffffff;\n            --text-secondary: #9ca3af;\n            --sent-message-bg: #8b5cf6;\n            --received-message-bg: #3f3f46;\n            --border-color: #333333;\n        }\n\n        * {\n            margin: 0 !important;\n            padding: 0 !important;\n            box-sizing: border-box !important;\n            -webkit-tap-highlight-color: transparent !important;\n        }\n\n        html, body {\n            height: 100% !important;\n            overflow: hidden !important;\n            background-color: var(--bg-primary) !important;\n        }\n\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif !important;\n            color: var(--text-primary) !important;\n            display: flex !important;\n            position: fixed !important;\n            width: 100% !important;\n            top: 0 !important;\n            left: 0 !important;\n            overscroll-behavior: none !important;\n        }\n\n        .sidebar {\n            width: 300px !important;\n            background-color: var(--bg-secondary) !important;\n            border-right: 1px solid var(--border-color) !important;\n            overflow-y: auto !important;\n            display: flex !important;\n            flex-direction: column !important;\n            transition: transform 0.3s ease !important;\n            z-index: 1000 !important;\n        }\n\n        .chat-room {\n            padding: 15px 20px !important;\n            cursor: pointer !important;\n            border-bottom: 1px solid var(--border-color) !important;\n            display: flex !important;\n            justify-content: space-between !important;\n            align-items: center !important;\n            transition: background-color 0.2s !important;\n            min-height: 70px !important;\n        }\n\n        .chat-room:hover {\n            background-color: #2a2a2a !important;\n        }\n\n        .chat-room.active {\n            background-color: #2d2d2d !important;\n        }\n\n        .chat-room-name {\n            font-weight: 500 !important;\n            font-size: 15px !important;\n            color: var(--text-primary) !important;\n        }\n\n        .unread-badge {\n            background-color: var(--violet) !important;\n            color: white !important;\n            border-radius: 12px !important;\n            padding: 2px 8px !important;\n            font-size: 12px !important;\n            display: none;\n            font-weight: bold !important;\n            min-width: 20px !important;\n            text-align: center !important;\n        }\n\n        .main-chat {\n            flex: 1 !important;\n            display: flex !important;\n            flex-direction: column !important;\n            background-color: var(--bg-primary) !important;\n            position: relative !important;\n            height: 100vh !important;\n            overflow: hidden !important;\n        }\n\n        .chat-header {\n            height: 70px !important;\n            background-color: var(--bg-secondary) !important;\n            border-bottom: 1px solid var(--border-color) !important;\n            display: flex !important;\n            align-items: center !important;\n            justify-content: space-between !important;\n            padding: 0 20px !important;\n            position: relative !important;\n            z-index: 10 !important;\n            flex-shrink: 0 !important;\n        }\n\n        .menu-toggle {\n            display: none !important;\n            background: none !important;\n            border: none !important;\n            color: var(--text-primary) !important;\n            font-size: 24px !important;\n            cursor: pointer !important;\n            padding: 10px !important;\n        }\n\n        .messages-container {\n            flex: 1 !important;\n            overflow-y: auto !important;\n            padding: 20px !important;\n            display: flex !important;\n            flex-direction: column !important;\n            gap: 10px !important;\n            background-color: var(--bg-primary) !important;\n            position: relative !important;\n            height: calc(100vh - 140px) !important;\n            padding-bottom: calc(20px + env(safe-area-inset-bottom)) !important;\n        }\n\n        .message-wrapper {\n            display: flex !important;\n            flex-direction: column !important;\n            gap: 4px !important;\n            max-width: 70% !important;\n            opacity: 1 !important;\n            transform: translateY(0) !important;\n        }\n\n        .message-wrapper.sent {\n            align-self: flex-end !important;\n        }\n\n        .message-wrapper.received {\n            align-self: flex-start !important;\n        }\n\n        .message {\n            padding: 12px 16px !important;\n            border-radius: 20px !important;\n            word-wrap: break-word !important;\n            font-size: 15px !important;\n            line-height: 1.4 !important;\n            position: relative !important;\n            color: var(--text-primary) !important;\n        }\n\n        .message.sent {\n            background-color: var(--sent-message-bg) !important;\n            color: white !important;\n            border-bottom-right-radius: 5px !important;\n        }\n\n        .message.received {\n            background-color: var(--received-message-bg) !important;\n            border-bottom-left-radius: 5px !important;\n        }\n\n        .input-container {\n            height: 70px !important;\n            background-color: var(--bg-secondary) !important;\n            border-top: 1px solid var(--border-color) !important;\n            display: flex !important;\n            align-items: center !important;\n            padding: 0 20px !important;\n            position: relative !important;\n            z-index: 10 !important;\n            flex-shrink: 0 !important;\n            padding-bottom: env(safe-area-inset-bottom) !important;\n            gap: 10px !important;\n        }\n\n        .message-input {\n            flex: 1 !important;\n            padding: 12px 16px !important;\n            border-radius: 20px !important;\n            border: 1px solid var(--border-color) !important;\n            background-color: #333 !important;\n            color: var(--text-primary) !important;\n            font-size: 15px !important;\n            transition: all 0.2s !important;\n        }\n\n        .message-input:focus {\n            outline: none !important;\n            background-color: #404040 !important;\n            border-color: var(--violet) !important;\n        }\n\n        .message-input:disabled {\n            opacity: 0.5 !important;\n            cursor: not-allowed !important;\n        }\n\n        .send-button {\n            background-color: var(--violet) !important;\n            color: white !important;\n            border: none !important;\n            border-radius: 50% !important;\n            width: 40px !important;\n            height: 40px !important;\n            cursor: pointer !important;\n            display: flex !important;\n            align-items: center !important;\n            justify-content: center !important;\n            transition: background-color 0.2s !important;\n            font-size: 18px !important;\n        }\n\n        .send-button:hover {\n            background-color: var(--purple) !important;\n        }\n\n        .send-button:disabled {\n            opacity: 0.5 !important;\n            cursor: not-allowed !important;\n        }\n\n        .timestamp {\n            font-size: 11px !important;\n            color: var(--text-secondary) !important;\n            margin: 2px 8px !important;\n        }\n\n        .message-wrapper.sent .timestamp {\n            text-align: right !important;\n        }\n\n        .message-wrapper.received .timestamp {\n            text-align: left !important;\n        }\n\n        .messages-container::after {\n            content: '' !important;\n            position: sticky !important;\n            bottom: 0 !important;\n            left: 0 !important;\n            right: 0 !important;\n            height: 20px !important;\n            background: linear-gradient(to top, var(--bg-primary), transparent) !important;\n            pointer-events: none !important;\n            margin-top: -20px !important;\n        }\n\n        .chat-header h2 {\n            color: var(--text-primary) !important;\n            font-size: 16px !important;\n            font-weight: 600 !important;\n        }\n\n        @media (max-width: 768px) {\n            .sidebar {\n                position: fixed !important;\n                left: 0 !important;\n                top: 0 !important;\n                bottom: 0 !important;\n                transform: translateX(-100%) !important;\n            }\n\n            .sidebar.show {\n                transform: translateX(0) !important;\n            }\n\n            .menu-toggle {\n                display: block !important;\n            }\n\n            .input-container {\n                padding-bottom: calc(10px + env(safe-area-inset-bottom)) !important;\n            }\n\n            .messages-container {\n                height: calc(100vh - 140px - env(safe-area-inset-bottom)) !important;\n            }\n\n            .message-wrapper {\n                max-width: 85% !important;\n            }\n\n            .chat-header {\n                padding-left: 10px !important;\n                padding-right: 10px !important;\n            }\n        }\n\n        ::-webkit-scrollbar {\n            width: 6px !important;\n        }\n\n        ::-webkit-scrollbar-track {\n            background: var(--bg-primary) !important;\n        }\n\n        ::-webkit-scrollbar-thumb {\n            background: var(--border-color) !important;\n            border-radius: 3px !important;\n        }\n\n        ::-webkit-scrollbar-thumb:hover {\n            background: #555 !important;\n        }\n\n        @supports (padding: max(0px)) {\n            .input-container {\n                padding-bottom: max(15px, env(safe-area-inset-bottom)) !important;\n            }\n\n            .messages-container {\n                padding-bottom: max(20px, calc(20px + env(safe-area-inset-bottom))) !important;\n            }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"sidebar\" id=\"sidebar\"></div>\n    <div class=\"main-chat\">\n        <div class=\"chat-header\">\n            <button class=\"menu-toggle\" id=\"menuToggle\">☰</button>\n            <h2 id=\"current-chat-name\">Select a chat</h2>\n            <div style=\"width: 24px !important;\"></div>\n        </div>\n        <div class=\"messages-container\" id=\"messages\"></div>\n        <div class=\"input-container\">\n            <input type=\"text\" class=\"message-input\" id=\"messageInput\" placeholder=\"Message\" disabled>\n            <button class=\"send-button\" id=\"sendButton\" disabled>↑</button>\n        </div>\n    </div>\n\n    <script>\n        let currentMembership = null;\n        let chatData = {};\n\n        async function initializeSocket() {\n            if (!frappe.realtime) {\n                frappe.realtime = new frappe.RealTimeClient();\n            }\n            const socketio_port = frappe.boot.socketio_port || 9000;\n            await frappe.realtime.init(socketio_port);\n            frappe.realtime.socket.emit('join', 'website');\n            frappe.realtime.on('chat_update', fetchChats);\n            \n            await fetchChats();\n        }\n\n        function scrollToBottom(smooth = true) {\n            const messagesContainer = document.getElementById('messages');\n            messagesContainer.style.scrollBehavior = smooth ? 'smooth' : 'auto';\n            messagesContainer.scrollTop = messagesContainer.scrollHeight;\n            \n            setTimeout(() => {\n                messagesContainer.style.scrollBehavior = 'smooth';\n            }, 0);\n        }\n\n        function isAtBottom() {\n            const messagesContainer = document.getElementById('messages');\n            const threshold = 100;\n            return messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < threshold;\n        }\n\n        document.getElementById('menuToggle').addEventListener('click', () => {\n            document.getElementById('sidebar').classList.toggle('show');\n        });\n\n        document.addEventListener('click', (e) => {\n            const sidebar = document.getElementById('sidebar');\n            const menuToggle = document.getElementById('menuToggle');\n            \n            if (window.innerWidth <= 768 && \n                !sidebar.contains(e.target) && \n                e.target !== menuToggle) {\n                sidebar.classList.remove('show');\n            }\n        });\n\n        async function fetchChats() {\n            try {\n                const response = await fetch('/api/v2/method/personal_trainer_app.api.fetch_all_chats');\n                const result = await response.json();\n                chatData = result.data;\n                renderChatRooms();\n                if (currentMembership) {\n                    const wasAtBottom = isAtBottom();\n                    renderMessages();\n                    if (wasAtBottom) {\n                        scrollToBottom();\n                    }\n                }\n            } catch (error) {\n                console.error('Error fetching chats:', error);\n            }\n        }\n\n        function renderChatRooms() {\n            const sidebar = document.getElementById('sidebar');\n            sidebar.innerHTML = '';\n\n            Object.entries(chatData).forEach(([membership, data]) => {\n                const unreadCount = data.chats.filter(chat => \n                    chat.response === 1 && chat.read === 0\n                ).length;\n\n                const roomDiv = document.createElement('div');\n                roomDiv.className = `chat-room${currentMembership === membership ? ' active' : ''}`;\n                roomDiv.innerHTML = `\n                    <span class=\"chat-room-name\">${data.client_name}</span>\n                    <span class=\"unread-badge\" ${unreadCount > 0 ? 'style=\"display: inline !important;\"' : ''}>${unreadCount}</span>\n                `;\n\n                roomDiv.addEventListener('click', () => {\n                    selectChatRoom(membership);\n                    if (window.innerWidth <= 768) {\n                        document.getElementById('sidebar').classList.remove('show');\n                    }\n                });\n                sidebar.appendChild(roomDiv);\n            });\n        }\n\n        async function selectChatRoom(membership) {\n            currentMembership = membership;\n            const messageInput = document.getElementById('messageInput');\n            const sendButton = document.getElementById('sendButton');\n            const currentChatName = document.getElementById('current-chat-name');\n\n            messageInput.disabled = false;\n            sendButton.disabled = false;\n            currentChatName.textContent = chatData[membership].client_name;\n\n            renderChatRooms();\n            renderMessages();\n\n            await fetch(`/api/v2/method/personal_trainer_app.api.mark_chats_read?membership=${membership}&coach=1`);\n            \n            chatData[membership].chats.forEach(chat => {\n                if (chat.response === 1) chat.read = 1;\n            });\n            renderChatRooms();\n            scrollToBottom(false);\n        }\n\n        function renderMessages() {\n            const messagesContainer = document.getElementById('messages');\n            messagesContainer.innerHTML = '';\n\n            if (!currentMembership) return;\n\n            chatData[currentMembership].chats.forEach((chat, index) => {\n                const wrapperDiv = document.createElement('div');\n                wrapperDiv.className = `message-wrapper ${chat.response ? 'sent' : 'received'}`;\n\n                const messageDiv = document.createElement('div');\n                messageDiv.className = `message ${chat.response ? 'sent' : 'received'}`;\n                messageDiv.textContent = chat.message;\n\n                const timestamp = new Date(chat.creation).toLocaleTimeString([], \n                    { hour: '2-digit', minute: '2-digit' }\n                );\n\n                const timeDiv = document.createElement('div');\n                timeDiv.className = 'timestamp';\n                timeDiv.textContent = timestamp;\n\n                wrapperDiv.appendChild(messageDiv);\n                wrapperDiv.appendChild(timeDiv);\n                messagesContainer.appendChild(wrapperDiv);\n\n                // Trigger animation after a small delay\n                setTimeout(() => {\n                    wrapperDiv.style.opacity = '1';\n                    wrapperDiv.style.transform = 'translateY(0)';\n                }, index * 50); // Stagger the animations\n            });\n        }\n\n        async function sendMessage() {\n            const messageInput = document.getElementById('messageInput');\n            const message = messageInput.value.trim();\n\n            if (!message || !currentMembership) return;\n\n            try {\n                await fetch(`/api/v2/method/personal_trainer_app.api.send_chat?membership=${currentMembership}&message=${encodeURIComponent(message)}&response=1`);\n                messageInput.value = '';\n                scrollToBottom();\n            } catch (error) {\n                console.error('Error sending message:', error);\n            }\n        }\n\n        // Event Listeners\n        document.getElementById('messageInput').addEventListener('keypress', (e) => {\n            if (e.key === 'Enter' && !e.shiftKey) {\n                e.preventDefault(); // Prevent newline\n                sendMessage();\n            }\n        });\n\n        document.getElementById('sendButton').addEventListener('click', sendMessage);\n\n        // Handle resize events\n        let resizeTimeout;\n        window.addEventListener('resize', () => {\n            clearTimeout(resizeTimeout);\n            resizeTimeout = setTimeout(() => {\n                if (window.innerWidth > 768) {\n                    document.getElementById('sidebar').classList.remove('show');\n                }\n                if (isAtBottom()) {\n                    scrollToBottom(false);\n                }\n            }, 100);\n        });\n\n        // Handle mobile keyboard\n        const messageInput = document.getElementById('messageInput');\n        messageInput.addEventListener('focus', () => {\n            setTimeout(() => {\n                scrollToBottom();\n            }, 300);\n        });\n\n        // Initialize\n        document.addEventListener('DOMContentLoaded', () => {\n            initializeSocket();\n\n            // Prevent double tap zoom on iOS\n            document.addEventListener('touchend', (e) => {\n                const now = Date.now();\n                if (now - lastTap < 500) {\n                    e.preventDefault();\n                }\n                lastTap = now;\n            });\n\n            // Add smooth scrolling when new messages arrive\n            const messagesContainer = document.getElementById('messages');\n            const options = {\n                root: messagesContainer,\n                rootMargin: '0px',\n                threshold: 0.8\n            };\n\n            const observer = new IntersectionObserver((entries) => {\n                entries.forEach(entry => {\n                    if (entry.isIntersecting) {\n                        entry.target.style.opacity = '1';\n                        entry.target.style.transform = 'translateY(0)';\n                    }\n                });\n            }, options);\n\n            // Observe new messages as they're added\n            const observeNewMessages = () => {\n                const messages = document.querySelectorAll('.message-wrapper');\n                messages.forEach(message => observer.observe(message));\n            };\n\n            // Handle visibility change\n            document.addEventListener('visibilitychange', () => {\n                if (!document.hidden && currentMembership) {\n                    fetchChats();\n                }\n            });\n\n            // Handle online/offline status\n            window.addEventListener('online', async () => {\n                if (currentMembership) {\n                    await initializeSocket();\n                }\n            });\n\n            // Prevent pull-to-refresh on mobile\n            document.body.style.overscrollBehavior = 'none';\n        });\n\n        // Initialize last tap for double tap prevention\n        let lastTap = 0;\n    </script>\n</body>\n</html>",
  "main_section_md": null,
  "meta_description": null,
  "meta_image": null,
  "meta_title": null,
  "modified": "2024-11-18 14:56:07.528122",
  "module": "Personal Trainer",
  "name": "admin-chat",
  "page_blocks": [],
  "published": 1,
  "route": "admin-chat",
  "show_sidebar": 0,
  "show_title": 0,
  "slideshow": null,
  "start_date": null,
  "text_align": "Left",
  "title": "admin-chat",
  "website_sidebar": null
 }
]